version: '3.8'

services:
  sonic-agent:
    build: .
    container_name: sonic-agent-${POP_ID:-pop1}-${ROUTER_ID:-router1}
    restart: unless-stopped
    network_mode: host
    privileged: true
    init: true
    
    environment:
      KAFKA_BROKER: ${KAFKA_BROKER:-10.30.7.52:9092}
      POP_ID: ${POP_ID:-pop1}
      ROUTER_ID: ${ROUTER_ID:-router1}
      VIRTUAL_OPERATOR: ${VIRTUAL_OPERATOR:-vOp2}
      CONFIG_TOPIC: config_${VIRTUAL_OPERATOR:-vOp2}
      MONITORING_TOPIC: monitoring_${VIRTUAL_OPERATOR:-vOp2}
      ASSIGNED_TRANSCEIVERS: ${ASSIGNED_TRANSCEIVERS:-Ethernet192}
      IFNAME_TO_PORTNUM_JSON: '${IFNAME_TO_PORTNUM_JSON:-{"Ethernet192": 192}}'
    
    volumes:
      # SONiC Python packages
      - /usr/local/lib/python3.7/dist-packages:/usr/local/lib/python3.7/dist-packages:ro
      - /usr/lib/python3.7/dist-packages:/usr/lib/python3.7/dist-packages:ro
      # SONiC CLI and Configuration
      - /usr/local/bin:/usr/local/bin:ro
      - /usr/bin:/usr/bin:ro
      - /etc/sonic:/etc/sonic:ro
      - /var/run/redis:/var/run/redis:rw
      # Hardware Access
      - /dev:/dev:rw
      - /sys/class:/sys/class:rw
      - /sys/devices:/sys/devices:rw
      # SONiC Runtime
      - /usr/share/sonic:/usr/share/sonic:ro
      - /var/log/sonic:/var/log/sonic:rw
      - /var/run:/var/run:rw
      - /tmp:/tmp:rw
      # Agent Code
      - ./core:/app/core:ro
      - ./config:/app/config:ro
      - ./models:/app/models:ro
      - ./scripts:/app/scripts:ro