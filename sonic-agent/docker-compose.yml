version: '3.8'

services:
  sonic-agent:
    build:
      context: .
      # Use host network during IMAGE BUILD (for pip, apt, etc.)
      network: host
    image: sonic-agent:latest
    container_name: sonic-agent-${POP_ID}-${ROUTER_ID}
    restart: unless-stopped

    # Runtime networking / privileges
    network_mode: host
    privileged: true
    pid: host
    init: true

    # Load variables from .env in the project root
    env_file:
      - .env

    environment:
      # Required identity / control-plane
      POP_ID: ${POP_ID}
      ROUTER_ID: ${ROUTER_ID}
      VIRTUAL_OPERATOR: ${VIRTUAL_OPERATOR}
      KAFKA_BROKER: ${KAFKA_BROKER}

      # Hardware configuration (must be JSON where required by Settings)
      ASSIGNED_TRANSCEIVERS: ${ASSIGNED_TRANSCEIVERS}
      IFNAME_TO_PORTNUM_JSON: ${IFNAME_TO_PORTNUM_JSON}

      # Operational settings
      TELEMETRY_INTERVAL_SEC: ${TELEMETRY_INTERVAL_SEC}
      LOG_LEVEL: ${LOG_LEVEL}
      DEBUG_MODE: ${DEBUG_MODE}

      # Make host SONiC libs visible to python (for libswsscommon, etc.)
      LD_LIBRARY_PATH: "/host-libs/x86_64-linux-gnu:${LD_LIBRARY_PATH}"

    volumes:
      # SONiC system access
      - /etc/sonic:/etc/sonic:ro
      - /usr/share/sonic:/usr/share/sonic:ro
      - /var/run/redis:/var/run/redis:rw
      - /var/run/docker.sock:/var/run/docker.sock

      # Hardware access
      - /dev:/dev:rw
      - /sys/class:/sys/class:rw
      - /sys/devices:/sys/devices:rw
      - /sys/bus:/sys/bus:rw

      # Logs and data
      - ./logs:/app/logs:rw
      - /var/log/sonic-agent:/var/log/sonic-agent:rw

      # SONiC Python libraries from host (mounted under /sonic inside container)
      - /usr/local/lib/python3.9/dist-packages:/sonic/py3-local:ro
      - /usr/lib/python3/dist-packages:/sonic/py3-dist:ro
      - /usr/lib/python3.9/dist-packages:/sonic/py3-std:ro

      # Native SONiC shared libs (for libswsscommon.so.0, etc.)
      - /usr/lib/x86_64-linux-gnu:/host-libs/x86_64-linux-gnu:ro

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
