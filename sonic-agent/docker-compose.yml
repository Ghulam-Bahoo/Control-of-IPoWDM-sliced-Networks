version: '3.8'
services:
  sonic-agent:
    # build: .
    image: sonic-agent:latest 
    container_name: sonic-agent-${POP_ID}-${ROUTER_ID}
    restart: unless-stopped
    network_mode: host
    privileged: true
    pid: host
    init: true

    # Load variables from .env in the project root
    env_file:
      - .env

    environment:
      # Required identity / control-plane
      POP_ID: ${POP_ID}
      ROUTER_ID: ${ROUTER_ID}
      VIRTUAL_OPERATOR: ${VIRTUAL_OPERATOR}
      KAFKA_BROKER: ${KAFKA_BROKER}

      # Hardware configuration (must be JSON where required by Settings)
      ASSIGNED_TRANSCEIVERS: ${ASSIGNED_TRANSCEIVERS}
      IFNAME_TO_PORTNUM_JSON: ${IFNAME_TO_PORTNUM_JSON}

      # Operational settings
      TELEMETRY_INTERVAL_SEC: ${TELEMETRY_INTERVAL_SEC}
      LOG_LEVEL: ${LOG_LEVEL}
      DEBUG_MODE: ${DEBUG_MODE}

    volumes:
      # SONiC system access
      - /etc/sonic:/etc/sonic:ro
      - /usr/share/sonic:/usr/share/sonic:ro
      - /var/run/redis:/var/run/redis:rw
      - /var/run/docker.sock:/var/run/docker.sock

      # Hardware access
      - /dev:/dev:rw
      - /sys/class:/sys/class:rw
      - /sys/devices:/sys/devices:rw
      - /sys/bus:/sys/bus:rw

      # Logs and data
      - ./logs:/app/logs:rw
      - /var/log/sonic-agent:/var/log/sonic-agent:rw

      # SONiC Python libraries
      - /usr/lib/python3.7/dist-packages:/usr/lib/python3.7/dist-packages:ro
      - /usr/local/lib/python3.7/dist-packages:/usr/local/lib/python3.7/dist-packages:ro

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

